<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- SEO and Sharing Meta Tags -->
    <title>AI Educational Assistant</title>
    <meta name="description" content="A suite of specialized AI-powered tools for educators, designed to assist with item writing, lesson planning, and more. Compiled by Derrick Musamali.">
    <meta name="author" content="Derrick Musamali">
    <link rel="icon" href="https://raw.githubusercontent.com/derikmusa/ai-suite-assets/main/logo.jpeg" type="image/jpeg">

    <!-- Open Graph (Facebook, WhatsApp, etc.) -->
    <meta property="og:title" content="AI Educational Assistant Suite">
    <meta property="og:description" content="A collection of specialized AI tools for educators.">
    <meta property="og:image" content="https://raw.githubusercontent.com/derikmusa/ai-suite-assets/main/logo.jpeg">
    <meta property="og:type" content="website">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="AI Educational Assistant Suite">
    <meta name="twitter:description" content="A collection of specialized AI tools for educators.">
    <meta name="twitter:image" content="https://raw.githubusercontent.com/derikmusa/ai-suite-assets/main/logo.jpeg">

    <!--
      ******************************************************************
      * GOOGLE ANALYTICS SCRIPT
      ******************************************************************
    -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YCTLDP04EJ"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-YCTLDP04EJ');
    </script>

    <!-- Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 3px;}
        .markdown-content h1, .markdown-content h2, .markdown-content h3 { font-weight: 600; margin-top: 1rem; margin-bottom: 0.5rem; }
        .markdown-content h1 { font-size: 1.5em; } .markdown-content h2 { font-size: 1.25em; } .markdown-content h3 { font-size: 1.1em; }
        .markdown-content p { margin-bottom: 0.75rem; }
        .markdown-content ul, .markdown-content ol { margin-left: 1.5rem; margin-bottom: 0.75rem; }
        .markdown-content ul { list-style-type: disc; } .markdown-content ol { list-style-type: decimal; }
        .markdown-content li { margin-bottom: 0.25rem; }
        .markdown-content table { border-collapse: collapse; width: 100%; margin-bottom: 1rem; }
        .markdown-content th, .markdown-content td { border: 1px solid #d1d5db; padding: 0.5rem 0.75rem; }
        .markdown-content th { background-color: #f3f4f6; font-weight: 600; }
        .markdown-content blockquote { border-left: 4px solid #d1d5db; padding-left: 1rem; margin-left: 0; color: #4b5563; }
        .markdown-content code { background-color: #e5e7eb; padding: 0.125rem 0.25rem; border-radius: 0.25rem; font-family: monospace; }
        .markdown-content pre > code { display: block; padding: 0.75rem; white-space: pre-wrap; }
        .table-container { overflow-x: auto; }
        .blinking-cursor {
            display: inline-block;
            width: 8px;
            height: 1.2rem;
            background-color: #4f46e5;
            animation: blink 1s step-end infinite;
            vertical-align: bottom;
        }
        @keyframes blink {
            from, to { background-color: transparent }
            50% { background-color: #4f46e5; }
        }
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4f46e5;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-slate-100">
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect, useRef } = React;

      const Icon = ({ C, ...props }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>{C}</svg>;
      const SendIcon = (props) => <Icon {...props} C={<><path d="m22 2-7 20-4-9-9-4Z" /><path d="M22 2 11 13" /></>} />;
      const UploadIcon = (props) => <Icon {...props} C={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="17 8 12 3 7 8" /><line x1="12" y1="3" y2="15" /></>} />;
      const FileIcon = (props) => <Icon {...props} C={<><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" /><polyline points="14 2 14 8 20 8" /></>} />;
      const XIcon = (props) => <Icon {...props} C={<><line x1="18" y1="6" x2="6" y2="18" /><line x1="6" y1="6" x2="18" y2="18" /></>} />;
      const TrashIcon = (props) => <Icon {...props} C={<><path d="M3 6h18" /><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" /><line x1="10" y1="11" x2="10" y2="17" /><line x1="14" y1="11" x2="14" y2="17" /></>} />;
      const HomeIcon = (props) => <Icon {...props} C={<><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" /><polyline points="9 22 9 12 15 12 15 22" /></>} />;
      const MenuIcon = (props) => <Icon {...props} C={<><line x1="4" x2="20" y1="12" y2="12" /><line x1="4" x2="20" y1="6" y2="6" /><line x1="4" x2="20" y1="18" y2="18" /></>} />;
      const AlertTriangleIcon = (props) => <Icon {...props} C={<><path d="m21.73 18-8-14a2 2 0 0 0-3.46 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></>} />;

      // ******************************************************************
      // * GOOGLE APPS SCRIPT CONFIGURATION
      // * Replace this URL with your deployed GAS Web App URL
      // ******************************************************************
      const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzVdwuzxGLijhAKQWfbb3zp6FahMChD89wSa_VcT1uM-9RbVQuJiBtd_VcreXu7dxp9/exec';

      // ******************************************************************
      // * PROMPT MANAGEMENT FUNCTIONS
      // ******************************************************************
      const PromptManager = {
        cache: {},
        availableAssistants: [],

        // Fetch available assistant names from GAS
        async getAvailableAssistants() {
          try {
            const response = await fetch(`${GAS_WEB_APP_URL}?action=getAssistants`);
            const data = await response.json();
            if (data.success) {
              this.availableAssistants = data.assistants;
              return data.assistants;
            }
            throw new Error(data.error || 'Failed to fetch assistants');
          } catch (error) {
            console.error('Error fetching assistants:', error);
            // Fallback to default assistants if GAS fails
            return [
              "Item Writer",
              "Lesson Notes Generator",
              "Lesson Plans (with Biblical values)",
              "Lesson Plans (no Biblical values)",
              "Mark Scheme Generator",
              "Scheme of Work (with Biblical values)",
              "Scheme of Work (no Biblical values)",
              "Student Workbook",
              "UCE Project Work Assistant",
              "Lab Assistant"
            ];
          }
        },

        // Fetch specific prompt content from GAS
        async getPromptContent(assistantName) {
          // Check cache first
          if (this.cache[assistantName]) {
            return this.cache[assistantName];
          }

          try {
            const response = await fetch(`${GAS_WEB_APP_URL}?action=getPrompt&assistant=${encodeURIComponent(assistantName)}`);
            const data = await response.json();

            if (data.success && data.prompt) {
              // Cache the prompt
              this.cache[assistantName] = data.prompt;
              return data.prompt;
            }

            throw new Error(data.error || 'Prompt not found');
          } catch (error) {
            console.error(`Error fetching prompt for ${assistantName}:`, error);
            return null;
          }
        },

        // Clear cache (useful for development/testing)
        clearCache() {
          this.cache = {};
        }
      };

      const AI_PROVIDERS = [
        { key: 'google', label: 'Google Gemini', apiKeyName: 'googleApiKey', apiKeyUrl: 'https://aistudio.google.com/app/apikey', apiHost: 'https://generativelanguage.googleapis.com', models: [
            { name: 'gemini-2.5-pro', vision: true }, { name: 'gemini-2.5-flash', vision: true }, { name: 'gemini-1.5-pro-latest', vision: true }, { name: 'gemini-1.5-flash-latest', vision: true }
        ]},
        { key: 'openai', label: 'OpenAI GPT', apiKeyName: 'openaiApiKey', apiKeyUrl: 'https://platform.openai.com/api-keys', apiHost: 'https://api.openai.com', models: [
            { name: 'gpt-4o', vision: true }, { name: 'gpt-4-turbo', vision: true }, { name: 'gpt-3.5-turbo', vision: false }
        ]},
        { key: 'anthropic', label: 'Anthropic Claude', apiKeyName: 'anthropicApiKey', apiKeyUrl: 'https://console.anthropic.com/settings/keys', apiHost: 'https://api.anthropic.com', models: [
            { name: 'claude-3-opus-20240229', vision: true }, { name: 'claude-3-sonnet-20240229', vision: true }, { name: 'claude-3-haiku-20240307', vision: true }
        ]},
        { key: 'groq', label: 'Llama 3 (via Groq)', apiKeyName: 'groqApiKey', apiKeyUrl: 'https://console.groq.com/keys', apiHost: 'https://api.groq.com/openai', models: [
            { name: 'llama3-8b-8192', vision: false }, { name: 'llama3-70b-8192', vision: false }
        ]},
        { key: 'deepseek', label: 'DeepSeek', apiKeyName: 'deepseekApiKey', apiKeyUrl: 'https://platform.deepseek.com/api_keys', apiHost: 'https://api.deepseek.com', models: [
            { name: 'deepseek-chat', vision: false }
        ]},
        { key: 'qwen', label: 'Qwen (via Alibaba)', apiKeyName: 'qwenApiKey', apiKeyUrl: 'https://dashscope.console.aliyun.com/apiKey', apiHost: 'https://dashscope.aliyuncs.com/compatible-mode/v1', models: [
            { name: 'qwen-vl-plus', vision: true }, { name: 'qwen-long', vision: false }
        ]},
      ];

      const MarkdownRenderer = ({ content, isLoading }) => {
          const html = marked.parse(content || '');
          return (
              <div className="markdown-content"
                   dangerouslySetInnerHTML={{ __html: html + (isLoading ? '<span class="blinking-cursor"></span>' : '') }}
              />
          );
      };

      function App() {
        const getAssistantFromURL = () => {
            const params = new URLSearchParams(window.location.search);
            const assistantName = params.get('assistant');
            return assistantName || 'Item Writer'; // Default to first assistant
        };

        const [apiKeys, setApiKeys] = useState({});
        const [selectedProviderKey, setSelectedProviderKey] = useState('google');
        const [selectedModelName, setSelectedModelName] = useState('gemini-2.5-flash');
        const [autoDeleteHours, setAutoDeleteHours] = useState('2');
        const [chatHistory, setChatHistory] = useState([]);
        const [pendingFile, setPendingFile] = useState(null);
        const [pendingFilePreview, setPendingFilePreview] = useState(null);
        const [userInput, setUserInput] = useState('');
        const [isLoading, setIsLoading] = useState(false);
        const [error, setError] = useState('');
        const [customPromptContent, setCustomPromptContent] = useState('');
        const [activePromptKey, setActivePromptKey] = useState(getAssistantFromURL());
        const [isMenuOpen, setIsMenuOpen] = useState(false);
        const [isPromptMissing, setIsPromptMissing] = useState(false);
        const [availableAssistants, setAvailableAssistants] = useState([]);
        const [isLoadingAssistants, setIsLoadingAssistants] = useState(true);
        const [navigationMenu, setNavigationMenu] = useState({});
        const chatEndRef = useRef(null);

        const selectedProvider = AI_PROVIDERS.find(p => p.key === selectedProviderKey);
        const selectedModel = selectedProvider?.models.find(m => m.name === selectedModelName);
        const isFileUploadDisabled = !selectedModel?.vision;

        // Initialize assistants and navigation menu
        useEffect(() => {
            const initializeAssistants = async () => {
                setIsLoadingAssistants(true);
                try {
                    const assistants = await PromptManager.getAvailableAssistants();
                    setAvailableAssistants(assistants);

                    // Create navigation menu
                    const menu = {};
                    assistants.forEach(assistant => {
                        menu[assistant] = `?assistant=${encodeURIComponent(assistant)}`;
                    });
                    setNavigationMenu(menu);
                } catch (error) {
                    setError('Failed to load assistants. Please refresh the page.');
                } finally {
                    setIsLoadingAssistants(false);
                }
            };

            initializeAssistants();
        }, []);

        useEffect(() => {
            const currentPromptKey = getAssistantFromURL();
            setActivePromptKey(currentPromptKey);
            document.title = `${currentPromptKey} | AI Assistant`;

            // Load saved state
            const savedState = JSON.parse(localStorage.getItem('aiAssistantState')) || {};
            setApiKeys(savedState.apiKeys || {});
            setSelectedProviderKey(savedState.selectedProviderKey || 'google');
            setSelectedModelName(savedState.selectedModelName || 'gemini-2.5-flash');
            setAutoDeleteHours(savedState.autoDeleteHours || '2');

            // Initialize chat with prompt content
            const initializeChat = async () => {
                const chatKey = `chatHistory_${currentPromptKey}`;
                const savedChat = JSON.parse(localStorage.getItem(chatKey));

                let initialMessage = `Loading ${currentPromptKey} assistant...`;
                let initialHistory = [{ role: 'assistant', content: initialMessage, isLoading: true }];

                // Check for saved chat first
                if (savedChat) {
                    const hours = parseFloat(savedState.autoDeleteHours || '2');
                    if (savedState.autoDeleteHours === 'never' || (Date.now() - savedChat.timestamp) / 36e5 < hours) {
                        setChatHistory(savedChat.history);
                        return;
                    }
                }

                setChatHistory(initialHistory);

                // Fetch prompt content from GAS
                try {
                    const promptContent = await PromptManager.getPromptContent(currentPromptKey);

                    if (!promptContent) {
                        setIsPromptMissing(true);
                        setChatHistory([{ role: 'assistant', content: `The "${currentPromptKey}" assistant is not yet configured. Please contact the administrator.` }]);
                        return;
                    }

                    setIsPromptMissing(false);

                    // Parse prompt and get introduction message
                    let finalMessage = `${currentPromptKey} assistant is ready. How can I assist you?`;
                    try {
                        const promptJson = JSON.parse(promptContent);
                        const intro = promptJson?.interaction_flow?.introduction_message?.display_text;
                        if (intro) finalMessage = intro.replace(/\\n/g, '\n');
                    } catch(e) {
                        // If not JSON, use the content as-is or default message
                        finalMessage = `${currentPromptKey} assistant is ready. How can I assist you?`;
                    }

                    setChatHistory([{ role: 'assistant', content: finalMessage }]);
                } catch (error) {
                    setError('Failed to load assistant configuration. Please refresh the page.');
                    setChatHistory([{ role: 'assistant', content: 'Failed to load assistant. Please refresh the page.' }]);
                }
            };

            if (!isLoadingAssistants) {
                initializeChat();
            }
        }, [window.location.search, isLoadingAssistants]);

        useEffect(() => {
            localStorage.setItem('aiAssistantState', JSON.stringify({ apiKeys, selectedProviderKey, selectedModelName, autoDeleteHours }));
        }, [apiKeys, selectedProviderKey, selectedModelName, autoDeleteHours]);

        useEffect(() => {
            if (chatHistory && chatHistory.length > 0 && !chatHistory[chatHistory.length - 1]?.isLoading) {
                 const chatKey = `chatHistory_${activePromptKey}`;
                 localStorage.setItem(chatKey, JSON.stringify({ history: chatHistory, timestamp: Date.now() }));
            }
        }, [chatHistory, activePromptKey]);

        const processFileForApi = (file) => {
            return new Promise((resolve, reject) => {
                if (!file) reject("No file provided");
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve({ mime_type: file.type, data: reader.result.split(',')[1] });
                reader.onerror = (error) => reject(error);
            });
        };

        const handleSendMessage = async () => {
            const apiKey = apiKeys[selectedProvider.apiKeyName];
            if ((!userInput.trim() && !pendingFile) || isLoading) return;
            if (!apiKey) { setError(`Please enter your ${selectedProvider.label} API Key.`); return; }

            setIsLoading(true);
            setError('');

            let fileDataForApi = null;
            if (pendingFile && !isFileUploadDisabled) {
                try {
                    fileDataForApi = await processFileForApi(pendingFile);
                } catch(e) { setError("Could not read file."); setIsLoading(false); return; }
            }

            const userMessage = { role: 'user', content: userInput, file: pendingFile ? { name: pendingFile.name, previewUrl: pendingFilePreview } : null, fileDataForApi };
            const newHistory = [...chatHistory, userMessage, { role: 'assistant', content: '', isLoading: true }];
            setChatHistory(newHistory);
            setUserInput(''); setPendingFile(null); setPendingFilePreview(null);

            // Get system prompt from GAS
            let systemPrompt = '';
            try {
                systemPrompt = activePromptKey === 'custom' ? customPromptContent : await PromptManager.getPromptContent(activePromptKey);
                if (!systemPrompt) {
                    throw new Error('Failed to load system prompt');
                }
            } catch (error) {
                setError('Failed to load assistant configuration. Please try again.');
                setChatHistory(prev => prev.slice(0, -2));
                setIsLoading(false);
                return;
            }

            const historyForApi = newHistory.slice(0, -1); // Don't include the empty assistant message

            try {
                let requestUrl, requestHeaders, requestBody;

                if (selectedProvider.key === 'google') {
                    requestUrl = `${selectedProvider.apiHost}/v1beta/models/${selectedModel.name}:streamGenerateContent?key=${apiKey}&alt=sse`;
                    requestHeaders = { 'Content-Type': 'application/json' };
                    const geminiMessages = historyForApi.map(msg => {
                        const parts = [{ text: msg.content || "" }];
                        if (msg.role === 'user' && msg.fileDataForApi) {
                            parts.push({ inline_data: { mime_type: msg.fileDataForApi.mime_type, data: msg.fileDataForApi.data } });
                        }
                        return { role: msg.role === 'user' ? 'user' : 'model', parts };
                    });
                    requestBody = JSON.stringify({ contents: geminiMessages, systemInstruction: { parts: [{ text: systemPrompt }] } });
                } else { // OpenAI-compatible APIs (OpenAI, Groq, Deepseek, Qwen)
                    requestUrl = `${selectedProvider.apiHost}/v1/chat/completions`;
                    requestHeaders = { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` };
                    const messages = historyForApi.map(msg => {
                        const content = [{ type: 'text', text: msg.content || "" }];
                        if (msg.role === 'user' && msg.fileDataForApi) {
                            content.push({ type: 'image_url', image_url: { url: `data:${msg.fileDataForApi.mime_type};base64,${msg.fileDataForApi.data}` } });
                        }
                        return { role: msg.role, content: content.length === 1 && content[0].type === 'text' ? content[0].text : content };
                    });
                    requestBody = JSON.stringify({ model: selectedModel.name, messages: [{role: 'system', content: systemPrompt}, ...messages], stream: true });
                }

                const response = await fetch(requestUrl, { method: 'POST', headers: requestHeaders, body: requestBody });
                if (!response.ok) {
                    const errData = await response.json().catch(() => ({}));
                    throw new Error(errData.error?.message || `API request failed with status ${response.status}`);
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop();

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const dataStr = line.substring(6);
                            if (dataStr.trim() === '[DONE]') break;
                            try {
                                const data = JSON.parse(dataStr);
                                let textChunk = '';
                                if (selectedProvider.key === 'google') textChunk = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
                                else textChunk = data.choices?.[0]?.delta?.content || '';

                                if (textChunk) {
                                    setChatHistory(prev => {
                                        const newHistory = [...prev];
                                        newHistory[newHistory.length - 1].content += textChunk;
                                        return newHistory;
                                    });
                                }
                            } catch (e) { /* Ignore parsing errors */ }
                        }
                    }
                }

            } catch (err) {
                setError(err.message);
                setChatHistory(prev => prev.slice(0, -2));
            } finally {
                setChatHistory(prev => {
                    const newHistory = [...prev];
                    if (newHistory.length > 0) newHistory[newHistory.length - 1].isLoading = false;
                    return newHistory;
                });
                setIsLoading(false);
            }
        };

        const handleProviderChange = (e) => {
            const newProviderKey = e.target.value;
            setSelectedProviderKey(newProviderKey);
            setSelectedModelName(AI_PROVIDERS.find(p => p.key === newProviderKey).models[0].name);
        };

        const handleFileSelect = (e) => {
            const file = e.target.files[0];
            if (file && !isFileUploadDisabled) {
                setPendingFile(file);
                if (file.type.startsWith('image/')) { setPendingFilePreview(URL.createObjectURL(file)); }
                else { setPendingFilePreview(null); }
            }
        };

        const handleCustomPromptUpload = async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            try {
                const text = await file.text();
                setCustomPromptContent(text);
                setActivePromptKey('custom');
                setIsPromptMissing(false);
                setChatHistory([{ role: 'assistant', content: 'Custom prompt loaded. How can I assist?' }]);
            } catch (err) { setError('Could not read custom prompt file.'); }
        };

        const handlePromptSelectionChange = (e) => {
            if (e.target.value) {
                window.location.href = e.target.value;
            }
        };

        const clearChat = () => {
            const chatKey = `chatHistory_${activePromptKey}`;
            localStorage.removeItem(chatKey);
            setPendingFile(null); setPendingFilePreview(null); setError('');
            window.location.reload();
        };

        const handleApiKeyChange = (keyName, value) => {
            setApiKeys(prev => ({...prev, [keyName]: value}));
        };

        useEffect(() => { chatEndRef.current?.scrollIntoView({ behavior: 'smooth' }); }, [chatHistory[chatHistory.length - 1]?.content]);

        if (isLoadingAssistants) {
            return (
                <div className="flex items-center justify-center h-screen bg-slate-100">
                    <div className="text-center">
                        <div className="loading-spinner mx-auto mb-4"></div>
                        <p className="text-slate-600">Loading assistants...</p>
                    </div>
                </div>
            );
        }

        if (isPromptMissing) {
            return (
                <div className="flex items-center justify-center h-screen bg-slate-100 p-4">
                    <div className="text-center bg-white p-8 rounded-lg shadow-lg max-w-lg">
                        <AlertTriangleIcon className="w-16 h-16 text-amber-500 mx-auto mb-4" />
                        <h2 className="text-2xl font-bold text-slate-800 mb-2">Assistant Not Available</h2>
                        <p className="text-slate-600 mb-4">The "{activePromptKey}" assistant is currently not available.</p>
                        <p className="text-slate-600 mb-6">Please contact the administrator or try another assistant.</p>
                        <div className="text-sm text-indigo-700 font-semibold mb-6">
                            <p>Derrick Musamali</p>
                            <p>musadrk2@gmail.com / +256 750 470 234</p>
                        </div>
                        <div className="bg-slate-50 p-4 rounded-lg">
                            <p className="text-slate-600 mb-3">You can upload a custom prompt in a `.txt` or `.json` file to start a session.</p>
                            <label htmlFor="custom-prompt-upload-error" className="w-full inline-block px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition-colors cursor-pointer">Upload Custom Prompt</label>
                            <input id="custom-prompt-upload-error" type="file" className="hidden" accept=".txt,.json" onChange={handleCustomPromptUpload} />
                        </div>
                         <a href="./index.html" className="mt-6 inline-flex items-center justify-center gap-2 text-slate-600 hover:text-slate-900 font-semibold"><HomeIcon className="w-5 h-5"/>Return to Home</a>
                    </div>
                </div>
            );
        }

        return (
            <div className="relative h-screen overflow-hidden flex bg-white">
                {isMenuOpen && (<div className="fixed inset-0 bg-black bg-opacity-50 z-30 lg:hidden" onClick={() => setIsMenuOpen(false)}></div>)}
                <div className={`fixed top-0 left-0 z-40 h-full w-96 max-w-[90vw] bg-slate-800 text-white flex flex-col transition-transform duration-300 ease-in-out transform ${isMenuOpen ? 'translate-x-0' : '-translate-x-full'} lg:relative lg:translate-x-0 lg:flex-shrink-0`}>
                    <div className="flex-1 flex flex-col min-h-0">
                        <div className="flex justify-between items-center p-4 flex-shrink-0">
                             <h1 className="text-2xl font-bold">Settings</h1>
                             <button onClick={() => setIsMenuOpen(false)} className="lg:hidden p-1 text-slate-400 hover:text-white"><XIcon className="w-6 h-6"/></button>
                        </div>
                        <div className="flex-1 overflow-y-auto custom-scrollbar p-4 space-y-5">
                            <div>
                                <label className="text-sm text-slate-400">Select an Assistant</label>
                                <select onChange={handlePromptSelectionChange} value={navigationMenu[activePromptKey] || ""} className="w-full mt-1 p-2 bg-slate-700 border border-slate-600 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                    {availableAssistants.map(assistant => (
                                        <option key={assistant} value={navigationMenu[assistant]}>{assistant}</option>
                                    ))}
                                    {activePromptKey === 'custom' && <option value="">Custom Prompt</option>}
                                </select>
                                 <label htmlFor="custom-prompt-upload" className="mt-2 text-sm text-indigo-400 hover:text-indigo-300 cursor-pointer block text-center py-2 border border-dashed border-slate-600 rounded-md hover:border-indigo-500 transition-colors">Upload Custom Prompt</label>
                                <input id="custom-prompt-upload" type="file" className="hidden" accept=".txt,.json" onChange={handleCustomPromptUpload} />
                            </div>
                            <div>
                                <label className="text-sm text-slate-400">AI Provider</label>
                                <select value={selectedProviderKey} onChange={handleProviderChange} className="w-full mt-1 p-2 bg-slate-700 border border-slate-600 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                    {AI_PROVIDERS.map(p => <option key={p.key} value={p.key}>{p.label}</option>)}
                                </select>
                            </div>
                            <div>
                                <label className="text-sm text-slate-400">AI Model</label>
                                <select value={selectedModelName} onChange={(e) => setSelectedModelName(e.target.value)} className="w-full mt-1 p-2 bg-slate-700 border border-slate-600 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                    {selectedProvider?.models.map(model => <option key={model.name} value={model.name}>{model.name} {model.vision ? '📸' : ''}</option>)}
                                </select>
                            </div>
                             <div>
                                <label className="text-sm text-slate-400">{selectedProvider?.label} API Key</label>
                                <input type="password" value={apiKeys[selectedProvider?.apiKeyName] || ''} onChange={(e) => handleApiKeyChange(selectedProvider.apiKeyName, e.target.value)} placeholder={`Enter ${selectedProvider?.label} Key`} className="w-full mt-1 p-2 bg-slate-700 border border-slate-600 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" />
                                <a href={selectedProvider?.apiKeyUrl} target="_blank" className="text-xs text-indigo-400 hover:underline mt-1 block">Get your key here &raquo;</a>
                            </div>
                            <div><label className="text-sm text-slate-400">Auto-delete Chat</label><select value={autoDeleteHours} onChange={(e) => setAutoDeleteHours(e.target.value)} className="w-full mt-1 p-2 bg-slate-700 border border-slate-600 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"><option value="1">After 1 Hour</option><option value="2">After 2 Hours</option><option value="24">After 24 Hours</option><option value="never">Never</option></select></div>
                        </div>
                        <div className="p-4 mt-auto space-y-4 flex-shrink-0">
                            <details className="text-sm">
                                <summary className="cursor-pointer text-slate-400 hover:text-white">Contact & Support</summary>
                                <div className="p-3 mt-2 bg-slate-900 rounded-md space-y-3 text-xs">
                                    <p>Derrick Musamali</p>
                                    <p><a href="mailto:musadrk2@gmail.com" className="text-indigo-600 hover:underline">musadrk2@gmail.com</a></p>
                                    <p><a href="tel:+256750470234" className="text-indigo-600 hover:underline">Call: +256 750 470 234</a></p>
                                    <p><a href="https://wa.me/256750470234" target="_blank" className="text-indigo-400 hover:underline">WhatsApp Me</a></p>
                                </div>
                            </details>
                            <a href="./index.html" className="flex items-center justify-center gap-2 w-full text-center py-2 bg-slate-700 hover:bg-slate-600 rounded-md transition-colors"><HomeIcon className="w-5 h-5"/>Return to Home</a>
                            <p className="text-xs text-slate-500 text-center">A Project by Derrick Musamali</p>
                        </div>
                    </div>
                </div>

                <div className="flex-1 flex flex-col overflow-hidden">
                    <header className="p-4 border-b border-slate-200 flex justify-between items-center flex-shrink-0">
                        <button onClick={() => setIsMenuOpen(true)} className="p-1 text-slate-600 hover:text-slate-900 lg:hidden"><MenuIcon className="w-6 h-6" /></button>
                        <h2 className="text-xl font-semibold text-slate-800 absolute left-1/2 -translate-x-1/2 lg:static lg:translate-x-0">{activePromptKey} Assistant</h2>
                        <button onClick={clearChat} title="Clear chat history" className="p-2 rounded-full hover:bg-slate-200"><TrashIcon className="w-5 h-5 text-slate-500"/></button>
                    </header>
                    <main className="flex-1 overflow-y-auto p-6 custom-scrollbar bg-slate-50 pb-28">
                        <div className="space-y-6 max-w-4xl mx-auto">{chatHistory.map((msg, index) => <div key={index} className={`flex gap-3 ${msg.role === 'user' ? 'justify-end' : ''}`}>{msg.role !== 'user' && <div className="w-8 h-8 rounded-full bg-indigo-500 flex items-center justify-center text-white font-bold text-sm shrink-0">AI</div>}<div className={`p-4 rounded-lg ${msg.role === 'user' ? 'bg-indigo-600 text-white' : 'bg-white border border-slate-200'}`}>
                        {msg.file && (
                             <div className="mb-2 p-2 bg-indigo-500 rounded-md inline-block">
                                {msg.file.previewUrl ? <img src={msg.file.previewUrl} className="max-w-xs rounded-md"/> : <div className="flex items-center gap-2 p-2"><FileIcon className="w-6 h-6"/><span>{msg.file.name}</span></div>}
                             </div>
                        )}
                        <div className="table-container"><MarkdownRenderer content={msg.content} isLoading={msg.isLoading} /></div>
                    </div></div>)}<div ref={chatEndRef} /></div></main>
                    {error && <div className="p-4 bg-red-100 text-red-700 border-t border-red-200 flex-shrink-0">{error}</div>}
                    <footer className="p-4 border-t border-slate-200 bg-white flex-shrink-0 fixed bottom-0 left-0 lg:left-96 right-0">
                        <div className="relative max-w-4xl mx-auto">
                            {pendingFile && <div className="absolute bottom-full left-0 mb-2 max-w-md p-2"><div className="flex items-start gap-2 bg-slate-200 text-slate-700 rounded-lg p-2 text-sm">
                                {pendingFilePreview ? <img src={pendingFilePreview} alt="Preview" className="w-16 h-16 object-cover rounded-md"/> : <FileIcon className="w-12 h-12 text-slate-500 shrink-0"/>}
                                <div className="flex-grow"><p className="font-semibold">File attached:</p><p className="text-xs break-all">{pendingFile.name}</p></div>
                                <button onClick={() => {setPendingFile(null); setPendingFilePreview(null);}} className="p-1 rounded-full hover:bg-slate-300 shrink-0"><XIcon className="w-4 h-4" /></button>
                            </div></div>}
                            <div className="flex items-center gap-4">
                                <label htmlFor="file-upload" title={isFileUploadDisabled ? "File upload not supported by this model" : "Upload File"} className={`p-3 rounded-full hover:bg-slate-100 ${isFileUploadDisabled ? 'opacity-50 cursor-not-allowed' : 'cursor-pointer'}`}><UploadIcon className="w-6 h-6 text-slate-600"/></label>
                                <input id="file-upload" type="file" className="hidden" onChange={handleFileSelect} disabled={isFileUploadDisabled}/>
                                <textarea value={userInput} onChange={(e) => setUserInput(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && !e.shiftKey && (e.preventDefault(), handleSendMessage())} placeholder="Type your message or upload a file..." className="flex-1 p-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 resize-none" rows="1"/>
                                <button onClick={handleSendMessage} disabled={isLoading} className="p-3 rounded-full bg-indigo-600 text-white disabled:bg-slate-300 transition-colors hover:bg-indigo-700">
                                    {isLoading ? <div className="w-6 h-6 border-2 border-white border-t-transparent rounded-full animate-spin"></div> : <SendIcon className="w-6 h-6"/>}
                                </button>
                            </div>
                        </div>
                    </footer>
                </div>
            </div>
        );
      }
      const container = document.getElementById('root');
      const root = ReactDOM.createRoot(container);
      root.render(<App />);
    </script>
</body>
</html>
